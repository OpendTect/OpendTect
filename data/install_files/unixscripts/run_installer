#!/bin/bash
#________________________________________________________________________
#
# Copyright:    (C) 1995-2022 dGB Beheer B.V.
# License:      https://dgbes.com/licensing
#________________________________________________________________________
#
# Script to launch installer
#

PLFNAME=`uname`
if [[ "${PLFNAME}" = "Darwin" ]]; then
    echo "Unsupported platform"
    exit 1
else
    if [[ -n "${DTECT_APPL}" ]]; then
        if [[ "${DTECT_APPL}" == *6.4.0 || "${DTECT_APPL}" == *6.2.0 ]]; then
            unset LD_LIBRARY_PATH
        fi
    fi
fi

if [[ ! -f /bin/csh ]]; then
    echo "You do not have csh installed which is required by OpendTect"
    echo "Please install csh or contact your system administrator."
    exit 1
fi

scriptdir=`realpath $0`
curdir=`dirname $scriptdir`
qtfile=${curdir}/../plugins/platforms/libqxcb.so
if [[ ! -f "$qtfile" ]]; then
    echo "Qt platform plugin file $qtfile not found."
    echo "Can not display the installer window without this file."
    exit 1
fi

#check lib->Release link
if [[ ! -L ${curdir}/../lib ]]; then
    echo "${curdir}/../lib does not exist"
    echo "Please check your installation."
    echo "The installer can however continue normally."

    if [[ -n ${LD_LIBRARY_PATH} ]]; then
	export LD_LIBRARY_PATH=${curdir}:${LD_LIBRARY_PATH}
    else
	export LD_LIBRARY_PATH=${curdir}
    fi
fi

ldconfig=/sbin/ldconfig
odpng15libdir=${curdir}/png15
if [[ -x ${ldconfig} ]]; then
    syslibpng15=`${ldconfig} -p | grep libpng15.so.15 | grep 64 | tr ' ' '\n' | grep / | head -n 1`
else
    syslibpng15=/usr/lib64/libpng15.so.15
fi
if [[ -e "${syslibpng15}" ]]; then
    haspng=1
else
    if [[ -e "${odpng15libdir}" ]]; then
    	if [ -z ${SET_LD_LIBRARY_PATH+x} ]; then
	    export SET_LD_LIBRARY_PATH=${odpng15libdir}
	else
	    export SET_LD_LIBRARY_PATH=${odpng15libdir}:${LD_LIBRARY_PATH}
	fi
	haspng=1
    fi
fi

odpng16libdir=${curdir}/png16
if [[ -x ${ldconfig} ]]; then
    syslibpng16=`${ldconfig} -p | grep libpng16.so.16 | grep 64 | tr ' ' '\n' | grep / | head -n 1`
else
    syslibpng16=/usr/lib64/libpng16.so.16
fi
if [[ -e "${syslibpng16}" ]]; then
    haspng=1
else
    if [[ -e "${odpng16libdir}" ]]; then
    	if [ -z ${SET_LD_LIBRARY_PATH+x} ]; then
	    export SET_LD_LIBRARY_PATH=${odpng16libdir}
	else
	    export SET_LD_LIBRARY_PATH=${odpng16libdir}:${LD_LIBRARY_PATH}
	fi
	haspng=1
    fi
fi

if [[ -z ${haspng+x} ]]; then
    echo -e "\npng library is missing"
    echo  "Cannot launch the installer without it."
    exit 1
fi

odfreetypelibdir=${curdir}/freetype
if [[ -x ${ldconfig} ]]; then
    syslibfreetype=`${ldconfig} -p | grep libfreetype.so.6 | grep 64 | tr ' ' '\n' | grep / | head -n 1`
else
    syslibfreetype=/usr/lib64/libfreetype.so.6
fi
if [[ -e "${syslibfreetype}" ]]; then
    hasfreetype=1
else
    if [[ -e "${odfreetypelibdir}" ]]; then
    	if [ -z ${SET_LD_LIBRARY_PATH+x} ]; then
	    export SET_LD_LIBRARY_PATH=${odfreetypelibdir}
	else
	    export SET_LD_LIBRARY_PATH=${odfreetypelibdir}:${LD_LIBRARY_PATH}
	fi
	hasfreetype=1
    fi
fi

if [[ -z ${hasfreetype+x} ]]; then
    echo -e "\nfreetype library is missing"
    echo  "Cannot launch the installer without it."
    exit 1
fi

odfontconfiglibdir=${curdir}/fontconfig
if [[ -x ${ldconfig} ]]; then
    syslibfontconfig=`${ldconfig} -p | grep libfontconfig.so.1 | grep 64 | tr ' ' '\n' | grep / | head -n 1`
else
    syslibfontconfig=/usr/lib64/libfontconfig.so.1
fi
if [[ -e "${syslibfontconfig}" ]]; then
    hasfontconfig=1
else
    if [[ -e "${odfontconfiglibdir}" ]]; then
    	if [ -z ${SET_LD_LIBRARY_PATH+x} ]; then
	    export SET_LD_LIBRARY_PATH=${odfontconfiglibdir}
	else
	    export SET_LD_LIBRARY_PATH=${odfontconfiglibdir}:${LD_LIBRARY_PATH}
	fi
	hasfontconfig=1
    fi
fi

if [[ -z ${hasfontconfig+x} ]]; then
    echo -e "\nfontconfig library is missing"
    echo  "Cannot launch the installer without it."
    exit 1
fi

infomsg=`ldd $qtfile | grep "not found"`
if [[ -n "$infomsg" ]]; then
    infomsg=`ldd $qtfile | grep "not found" | grep -v $pngfilenm`
    if [[ -n "$infomsg" ]]; then
	echo  "System libraries listed below are missing, please install them and rerun the installer"
	echo "$infomsg"
        exit 1
    fi
fi

#get rid of the OD environment.
if [[ -n $DTECT_APPL ]]; then
    export DTECT_APPL=""
fi

start_time=$(date +%s)
if ! "${curdir}/od_instmgr" "$@"; then
    end_time=$(date +%s)
    elapsed=$(( end_time - start_time ))
    if [[ $elapsed -lt 1 && -z ${LD_LIBRARY_PATH+x} ]]; then
	if [ -z ${LD_LIBRARY_PATH+x} ]; then
	    export LD_LIBRARY_PATH=${SET_LD_LIBRARY_PATH}
	else
	    export LD_LIBRARY_PATH=${SET_LD_LIBRARY_PATH}:${LD_LIBRARY_PATH}
	fi
	if ! "${curdir}/od_instmgr" "$@"; then
	    exit $?
	fi
    fi
fi
